language: cpp
dist: trusty

compiler:
  - clang
  - gcc

env:
  global:
    # The next declaration is the encrypted COVERITY_SCAN_TOKEN, created
    #   via the "travis encrypt" command using the project repo's public key
    - secure: "VKbgWygGncf7s/CVdwQkKUOPIsH0DPyQkSh0o0Wvy69dfVw2qJ5P8dTQ+0LfUBxk2jErJ6iBS4rqnTPzp0wXpiI3RxQn2XuMNTLR+jcPNrpKW5iK1EcZZvaIarL03JRsbBdxfJf7EfLrGO3wG9ofCxG2cKwaUZSdG0i49leL2kpgp8CmApCCEPE9oKSaq4Oz0yW6jkxNhnbcFDKWtXHFoR1/TocqZuMvY5z6Rr3atFZRjsUGG+H52ji4bUx1cO+9b4o+OIsHInN7gSzORyV3tXj0hukWvAQvlu21nUHAb4WeNC7t5y/LRfPqLPwB7OrITuQ3vjKVMMsh7Sy4FoREIysqyWRY8dxSt0Clrd//dRG1KMovmcfGWKBJlVhXi070g4DaSdWW9VOxxHlp9KZBYi/R4GMtOinrjDA1F33Z8SXomoQU0xCxHKkSzZa6DWlu8fCut6I21HMQx82vfYDQAKLiYgg6AVBrtT5L0Qs9NrvL7EglvdD64X4wAv3vm13hArBA6v1O1HtlxGNgDsugMWcMy5bA76WDl7PNmRHwwFWR0IHm3lNKDHUoPgLb3BTEsiBGIe0Dq826XAZwqxLboz0lnxiZL9O2q64yS4aJLrqq3UYrj+lsdt0g0tUrChFsuiYPrqlOSeUqoW0kNaH1DiQbPKEBj2PoLfQ9KqH9WZQ="

  matrix:
    - ENABLE_UI=OFF
    - ENABLE_UI=ON

before_install:
  - sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test
  - sudo apt-get update -qq
  - sudo apt-get install -y -qq g++-4.8
  - if [ "$CXX" = "g++" ]; then export CXX="g++-4.8"; fi

before_script:
  - mkdir build
  - cd build
  - cmake .. -DENABLE_TESTS=ON -DENABLE_UI=$ENABLE_UI
  - echo -n | openssl s_client -connect https://scan.coverity.com:443 | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' | sudo tee -a /etc/ssl/certs/ca-

coverity_scan:
    project:
      name: "chongx1an/aseprite"
      description: "Animated sprite editor & pixel art tool (Windows, macOS, Linux)"
    notification_email: ch0ngx1an@hotmail.com
    build_command_prepend: 
    build_command: "make"
    branch_pattern: travis_test
    
script:
  - make
  - |
    if ctest --output-on-failure ; then
      if [[ "$ENABLE_UI" == "OFF" ]]; then
        export ASEPRITE=$PWD/bin/aseprite
        git clone https://github.com/aseprite/tests.git
        cd tests
        bash run-tests.sh
      fi
    fi
    
